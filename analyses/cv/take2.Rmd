---
title: "Coefficient of variation"
output: github_document
---


```{r setup, include=FALSE, echo = FALSE}
# Basic knitr options
library(knitr)
opts_chunk$set(comment = NA, 
               echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE,
               fig.width = 8.64,
               fig.height = 4.86,
               fig.path = 'figures/')
```


```{r}
# Libraries
library(tidyverse)
library(readxl)
library(ggplot2)
library(haven)

# Rufiji
ruf <- read_excel('data/Estimate of incidence for Rufiji-HF malaria cases.xlsx')
names(ruf) <- c('id', 'hf', 'district', 'village', 'population', 'cases2018', 'cases2016', 'x', 'y')
# Keep only the complete data
ruf <- ruf %>%
  filter(!is.na(population),
         !is.na(cases2018),
         !is.na(cases2016))
# Make long for years
ruf <- ruf %>% dplyr::select(-x,-y) %>%
  tidyr::gather(key, value, cases2018:cases2016) %>%
  mutate(key = as.numeric(gsub('cases', '', key))) %>%
  dplyr::rename(year = key,
                cases = value)
ruf <- ruf %>%
  mutate(incidence = cases / population * 1000)

# Collapse by year (Ruf data is also two years, so fine)
ruf <- ruf %>%
  group_by(hf) %>%
  summarise(population = mean(population),
            cases = mean(cases),
            incidence = mean(incidence))

# Mopeia
mop <- read_excel('data/20190628_pcd_hf_incidence.xlsx')
names(mop) <- c('hf', 'population', 'cases', 'person_years', 'incidence')
```

## The objective

We want a general notion of the the coefficient of variation (CV) in the incidence of malaria in the districts of Rufiji (Tanzania) and Mopeia (Mozambique). Are they similar? Must we use as high a CV for our power estimates in Rufiji as the one we used in Mopeia, or do we have evidence that suggets we could get by with a smaller CV (which would be operationally easier)? Let's dig in.

## The challenges  

### Description of the challenges 


Estimating this with the currently available data is not straightforward. In addition to the obvious shortcomings in using data from several years ago (things may have changed since then), there is a larger limitation: the data we have from Mopeia is at the person-level, whereas the Rufiji data is aggregated at the level of the ward (the Tanzanian equivalent of the posto administrativo).

One could simply take the CV in the Mopeia clusters and compare it with the CV in the Rufiji wards, but this comparison would be inappropriate since the sizes of these areas are so radically different. Whereas Mopeia clusters are made up of several hundred people, Rufiji wards include thousand (and in some cases, tens of thousands).

### Our previous (problematic) approach

Given the incompatabilities in the data being compared, we need to get creative. We previously estimated that CV for Mopeia, based on person-level data. We want to use similar methods on our two datasets, but their format (person-level vs. ward-level) is too dissimilar. Since we can't transform ward-level data into person-level data, we previously tried to do the opposite: transorm our person-level data (from Mopeia) to pseudo-ward-level data (ie, much larger numbers than clusters), using resampling. 

Resampling, however, was unreliable and problematic (given the relatively small dataset for Mopeia). The number of observations in the Mopeia ACD dataset (approximately 1500) was far too small to be compared with the level of aggregation in the Rufiji incidence dataset (many thousand per ward). In order to "upscale" the Mopeia dataset, we (inevitably) had to resample from the small (1500) ACD numbers multiple times. Resampling from the same set many times artificially deflates variation, hence the radically different CV estimates between the two datasets. Apples-to-oranges.

### Our current approach

Now we will try to get an apples-to-apples comparison by comparing health facility data from both Mopeia (generated by Aina) and Rufiji (generated by Issa). Once the data are properly and consistently formatted, the calcultion is straightforward

```{r}
cv_rufiji <- sd(ruf$incidence) / mean(ruf$incidence)
cv_mopeia <- sd(mop$incidence) / mean(mop$incidence)

print(paste0('Rufiji CV: ', round(cv_rufiji, digits = 2)))
print(paste0('Mopeia CV: ', round(cv_mopeia, digits = 2)))
```


## Results

The ward-level coefficient of variation of the incidence of Malaria in Rufiji is: `r round(cv_rufiji, digits = 2)`.

The pseudo-ward-level coefficient of variation in the incidence of Malaria in Mopeia is: `r round(cv_mopeia, digits = 2)`.

```{r}
pd <- tibble(Location = c('Rufiji','Mopeia'), cv = c(cv_rufiji, cv_mopeia))
ggplot(data = pd,
       aes(x = Location,
           y = cv)) +
  geom_bar(stat = 'identity') +
  theme_databrew() +
  scale_y_continuous(name = 'CV',
                     breaks = seq(0, 1, by = 0.1)) +
  geom_text(aes(label = round(cv, digits = 2)),
            nudge_y = -0.1,
            color = 'white')
```

## Interpretation

### General interpretation

Geographical variance in the incidence of malaria appears _higher_ in Rufiji than Mopeia, suggesting that - even if operationally more difficult - we should use a CV for our Rufiji sample size calculations which is (at least) as high as the one we observed in Mopeia.

### Caveats

There are differences in the (supposed) catchment areas of the two sites.

```{r}
combined <- 
  ruf %>%
  dplyr::select(hf, population, cases, incidence) %>% dplyr::mutate(location = 'Rufiji') %>%
  bind_rows(
    mop %>%
      dplyr::select(hf, population, cases, incidence) %>% dplyr::mutate(location = 'Mopeia')
  )

ggplot(data = combined,
       aes(x = population)) +
  geom_density(aes(fill = location))
```

## Technical details


This document was produced on `r Sys.Date()` on a `r Sys.info()['sysname']` machine (release `r Sys.info()['release']`. To reproduce, one should take the following steps:

- Clone the repository at https://github.com/databrew/bohemia

- Populate the `analyses/cv/data` directory with the following files:

```
└── Estimate of incidence for Rufiji-HF malaria cases.xlsx # sent by Issa on July 2 2019
└── 20190628_pcd_hf_incidence.xlsx # sent by Aina on June 30 2019
```

- "Render" (using `rmarkdown`) the code in `analysis/cv/README.Rmd`

Any questions or problems should be addressed to joe@databrew.cc
