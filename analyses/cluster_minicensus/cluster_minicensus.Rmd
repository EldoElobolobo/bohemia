---
title: "Cluster generation from (incomplete) minicensus"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: "hide"
---


```{r setup, include=FALSE, echo = FALSE}
# Basic knitr options
library(knitr)
opts_chunk$set(comment = NA, 
               # echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE,
               fig.width = 9.64,
               fig.height = 5.9,
               fig.path = 'figures/')
options(scipen=999)
```

```{r}
## Load libraries
library(bohemia)
library(ggplot2)
library(lubridate)
library(dplyr)
library(ggplot2)
library(sp)
library(raster)
library(ggthemes)
library(sf)
library(RColorBrewer)
library(readr)
library(tidyr)
library(leaflet)
library(rgeos)
# options(scipen = '999')
theme_set(databrew::theme_simple())
```


```{r}
# source('../../rpackage/bohemia/R/app_functions.R')

extract_ll <- function(x){
  lngs <- lats <- c()
  for(i in 1:length(x)){
    y <- x[i]
    lat <- unlist(lapply(strsplit(y[1], ' '), function(z){z[1]}))
    lng <- unlist(lapply(strsplit(y[1], ' '), function(z){z[2]}))
    lngs[i] <- lng; lats[i] <- lat
  }
  
  lng <- as.numeric(lngs); lat <- as.numeric(lats)
  return(tibble(lng = lng, lat = lat))
}

if('data.RData' %in% dir()){
  load('data.RData')
} else {
  pd_moz <- load_odk_data(the_country = 'Mozambique',
                    credentials_path = '../../credentials/credentials.yaml',
                    users_path = '../../credentials/users.yaml',
                    efficient = FALSE)
  pd_tza <- load_odk_data(the_country = 'Tanzania',
                      credentials_path = '../../credentials/credentials.yaml',
                      users_path = '../../credentials/users.yaml',
                      efficient = FALSE)
  is_local <- FALSE
  library(DBI)
  library(RPostgres)
  save(pd_moz,
       pd_tza,
       file = 'data.RData')
}

minicensus_main <- bind_rows(
  pd_moz$minicensus_main,
  pd_tza$minicensus_main
)
minicensus_people <- bind_rows(
  pd_moz$minicensus_people,
  pd_tza$minicensus_people
)
na_to_zero <- function(x){ifelse(is.na(x), 0, x)}
gps <- bohemia::gps

df_adjust <- function(df){
  df %>%
    mutate(n_households = ifelse(df$iso == 'TZA', n_households * 1,
                                 ifelse(df$iso == 'MOZ', n_households * 0.55, 
                                        NA)))
}

# source('global.R')
source('try_clusters_hh_level.R')

# Define the number of clusters required of each type
n_required <- 49

# Get age and household details
ages <- 
  bind_rows(
    pd_moz$minicensus_people %>% mutate(country = 'Mozambique'),
    pd_tza$minicensus_people %>% mutate(country = 'Tanzania')
  ) %>%
  mutate(days_old = Sys.Date() - dob) %>%
  mutate(years_old = days_old / 365.25) %>%
  mutate(is_child  = ifelse(country == 'Mozambique',
                            years_old >= 0 & years_old < 5,
                            years_old >= 5 & years_old < 15)) %>%
  group_by(country) %>%
  summarise(children = length(which(is_child)),
            people = n()) %>%
  ungroup %>%
  mutate(percent_children = round(children / people * 100, digits = 2))

hh <- bind_rows(
  pd_moz$minicensus_main %>% mutate(country = 'Mozambique'),
  pd_tza$minicensus_main %>% mutate(country = 'Tanzania')
) %>%
  group_by(country) %>%
  summarise(avg_size = mean(hh_size))
```

```{r}
# Create a df based on minicensus
left <- minicensus_people %>%
  left_join(minicensus_main %>% dplyr::select(instance_id,
                                              country = hh_country)) %>%
  mutate(years_old = (Sys.Date() - dob)/ 365.25) %>%
   mutate(is_child  = ifelse(country == 'Mozambique',
                            years_old >= 0 & years_old <= 5,
                            years_old >= 0 & years_old <= 15)) %>%
  mutate(is_boy = is_child & gender == 'male') %>%
  mutate(is_girl = is_child & gender == 'female') %>%
  group_by(country, instance_id) %>%
  summarise(n_members = n(),
            n_females = length(which(gender == 'female')),
            n_males = length(which(gender == 'male')),
            n_boys = length(which(is_boy)),
            n_girls = length(which(is_girl)),
            n_children = length(which(is_child)))
df <-
  left_join(left,
            minicensus_main %>% dplyr::select(instance_id,
                                              cows_1_year_plus = hh_n_cows_greater_than_1_year,
                                              cows_babies = hh_n_cows_less_than_1_year,
                                              pigs_6_weeks_plus = hh_n_pigs_greater_than_6_weeks,
                                              pigs_babies = hh_n_pigs_less_than_6_weeks,
                                              # country = hh_country,
                                              code = hh_hamlet_code,
                                              n_people = hh_size,
                                              location = hh_geo_location)) 
# Function for extracting lng and lat from a odk geocode object
extract_ll <- function(x){
  lngs <- lats <- c()
  for(i in 1:length(x)){
    y <- x[i]
    lat <- unlist(lapply(strsplit(y[1], ' '), function(z){z[1]}))
    lng <- unlist(lapply(strsplit(y[1], ' '), function(z){z[2]}))
    lngs[i] <- lng; lats[i] <- lat
  }
  
  lng <- as.numeric(lngs); lat <- as.numeric(lats)
  return(tibble(lng = lng, lat = lat))
}
locs <- extract_ll(df$location)
df$lng <- df$x <- locs$lng; df$lat <- df$y <- locs$lat
# df$code <- df$hh_hamlet_code
df <- left_join(df, bohemia::locations %>% 
                  dplyr::distinct(code, .keep_all = TRUE) %>%
                  dplyr::select(code, clinical_trial))

df <- df %>% filter(lat < -3)
df <- df %>%
  filter((lat < -16 & country == 'Mozambique') |
           (lat > -12 & country == 'Tanzania')
  )
library(sp)


# Aggregate df
df_agg <- df %>%
  group_by(code) %>%
  summarise(n_humans = sum(n_members),
            n_females = sum(n_females),
            n_males = sum(n_males),
            n_boys = sum(n_boys),
            n_girls = sum(n_girls),
            n_households = n(),
            n_children = sum(n_children),
            clinical_trial = dplyr::first(clinical_trial),
            country = dplyr::first(country),
            lng = mean(lng),
            lat = mean(lat),
            cows_1_year_plus = sum(cows_1_year_plus, na.rm = TRUE),
            cows_babies = sum(cows_babies, na.rm = TRUE),
            pigs_6_weeks_plus = sum(pigs_6_weeks_plus, na.rm = TRUE),
            pigs_babies = sum(pigs_babies, na.rm = TRUE))
df_agg <- df_agg %>% arrange(code)


# Read in cluster difficulty access scores (sent from Eldo)
difficulty <- read_csv('Mopeia.Hamlets_Accessibility_Scores.08.03.2021.csv')
difficulty <- difficulty %>% dplyr::select(code, difficulty = Accessibility_Scores)
difficulty$difficulty_value <- 
  ifelse(difficulty$difficulty == 'Easy', 1,
         ifelse(difficulty$difficulty == 'Normal', 2,
                ifelse(difficulty$difficulty == 'Hard', 3,
                       ifelse(difficulty$difficulty == 'Very Hard', 4,
                              NA))))
# Read in difficulty sent by Imani on March 22 2021
difficulty_tza <- read_csv('Bohemia hamlets_Accessibility.csv') %>%
  dplyr::select(code = hamlet_code,
                difficulty = Accessibility) %>%
  mutate(difficulty_value = 
             ifelse(difficulty == 'Easy', 1,
         ifelse(difficulty == 'Normal', 2,
                ifelse(difficulty == 'Hard', 3,
                       ifelse(difficulty == 'Very Hard', 4,
                              NA)))))
difficulty_tza <- difficulty_tza %>% filter(!duplicated(code))
difficulty <- bind_rows(difficulty, difficulty_tza)
difficulty <- difficulty %>% filter(!is.na(difficulty_value))
df_agg <- left_join(df_agg, difficulty)
df_agg <- df_agg %>% filter(!duplicated(code))
df_agg <- df_agg %>% filter(!is.na(difficulty_value))



# Get the data grouped by codes
codes <- sort(unique(df_agg$code))
locations_list <- list()
locations_list_ll <- list()
for(i in 1:length(codes)){
  # message('INDEX ', i)
  this_code <- codes[i]
  this_data <- df %>% filter(code == this_code) %>% mutate(x = lng, y = lat)
  coordinates(this_data) <- ~x+y
  proj4string(this_data) <- proj4string(bohemia::mop2)
  # CRS("+proj=utm +zone=36 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs")
  ss <- spTransform(this_data, CRS("+proj=utm +zone=36 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs"))
  # Get distances
  # dd <- rgeos::gDistance(ss, byid = TRUE)
  # Throw out anything more than 3k from centroid?
  centroid <- apply(coordinates(ss), 2, median)
  centroid <- data.frame(t(as.data.frame(centroid)))
  coordinates(centroid) <- ~x+y
  proj4string(centroid) <- proj4string(ss)
  distance_from_centroid <- rgeos::gDistance(ss, centroid, byid = TRUE)
  remove_these <- which(distance_from_centroid > 3000)
  if(length(remove_these) > 0){
    message('Removing ', length(remove_these), ' of ', nrow(ss), ' due to weird distances.')
    this_data <- this_data[!(1:nrow(this_data)) %in% remove_these,]
    ss <- ss[!(1:nrow(ss)) %in% remove_these,]
  } else {
    message('No removals for hamlet of ', nrow(ss))
  }
  locations_list_ll[[i]] <- this_data
  locations_list[[i]] <- ss
}
names(locations_list) <- names(locations_list_ll) <- codes
locations_df <- do.call('rbind', locations_list)
df <- locations_df@data
df_sp <- df
coordinates(df_sp) <- ~lng+lat
proj4string(df_sp) <- proj4string(bohemia::mop2)
df_proj <- spTransform(df_sp,   CRS("+proj=utm +zone=36 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs")
)


# Remake the aggregated dataframe, overwriting df
df <- df %>%
  group_by(code) %>%
  summarise(n_humans = sum(n_members),
            n_females = sum(n_females),
            n_males = sum(n_males),
            n_boys = sum(n_boys),
            n_girls = sum(n_girls),
            n_households = n(),
            n_children = sum(n_children),
            clinical_trial = dplyr::first(clinical_trial),
            country = dplyr::first(country),
            lng = mean(lng),
            lat = mean(lat),
            cows_1_year_plus = sum(cows_1_year_plus, na.rm = TRUE),
            cows_babies = sum(cows_babies, na.rm = TRUE),
            pigs_6_weeks_plus = sum(pigs_6_weeks_plus, na.rm = TRUE),
            pigs_babies = sum(pigs_babies, na.rm = TRUE))
df <- df %>% arrange(code)


# Combine with difficulty
df <- left_join(df, difficulty)
```


# Clustering based on minicensus-collected data {.tabset}

## Question

The question: How many clusters can we form with the data _already_ collected via the minicensus?

## Methods, parameters and assumptions


Clusters will be formed using full data from the minicensus on the spatial distribution of hamlets and certain "parameters" (buffer distance, minimum number of children per cluster, minimum number and type of animals, etc.). Since the minicensus is not finished, we cannot do this for all areas. However, we can do it for the areas done so far, so as to get a sense of how the observed spatial distribution of households (and demographic details) translate into clusters.

Since one incorrectly geocoded household can radically throw off the convex hull of a hamlet, we remove any households which are > 3km from the estimated centroid (median longitude / latitude) of the others from that hamlet.

We consider a cluster to be "complete" if it has the following characteristics:
- At least 35 children 
- No required number of animals  
- At least 2 kilometers between clusters of different treatment assignments (ie, a 1km "buffer" for each cluster, except in the case that the nearby cluster is of identical treatment assignment)  

We consider that the number of clusters is "enough" if 147 are reached (ie, sufficient for the random assignment of all clusters to 3 assignment groups of n=49).

We allow for clusters to be formed by more than one hamlet, but we do not allow for the splitting of hamlets. 

We consider that a "child" is some between 5 or younger in Mozambique and 5 to 15 in Tanzania. 


The clustering algorithm:  
- Starts at the hamlet of the district headquarters  
- Assess whether the hamlet is a complete cluster, then  
  - If it is a complete cluster, it moves on to the next hamlet and starts a new cluster  
  - If it is not a complete cluster, it adds the nearest hamlet to the same cluster (and so on)   
- Uses _pre-assigned_ (but random) treatment groups, so as to allow for the assignation of buffers only when necessary  

For estimating the number of people to be treated with ivermectin, we assume:
- That 2 of the 3 assignment groups will be treated  
- That 7% of non-child females will be pregnant and therefore not eligible for treatment
- That 5% of otherwise eligible people will choose not to participate   

```{r}
# Define function for getting the number of eligibles for treatment
get_eligible_for_ttm <- function(out, p_pregnant = 0.07, p_no_participate = 0.05){
  pd <- out$hamlet_xdf
  
  pdx <- pd %>%
    mutate(eligibles = n_humans - n_children) %>%
    mutate(non_child_females = n_females - n_girls) %>%
    group_by(assignment_group) %>%
    summarise(Humans = sum(n_humans),
              Children = sum(n_children),
             `Total non-children` = sum(eligibles),
              Females = sum(n_females),
             `Non-child females` = sum(non_child_females)) %>%
    mutate(`Estimated pregnant` = `Non-child females` * p_pregnant) %>%
    mutate(`Eligible for treatment` = `Total non-children` - `Estimated pregnant`) %>%
    mutate(`Coverage 90%` = `Eligible for treatment` * 0.9) %>%
    mutate(`Drug requirements 90` = `Coverage 90%` * 19.8) %>%
        mutate(`Coverage 80%` = `Eligible for treatment` * 0.8) %>%
    mutate(`Drug requirements 80` = `Coverage 80%` * 19.8) %>%
        mutate(`Coverage 70%` = `Eligible for treatment` * 0.7) %>%
    mutate(`Drug requirements 70` = `Coverage 70%` * 19.8) %>%
    mutate(assignment_group = as.character(assignment_group)) %>%
    mutate(assignment_group = ifelse(is.na(assignment_group), 'Buffer', assignment_group)) %>%
    dplyr::select(-`Non-child females`)
  no_buffer <- pdx %>% filter(assignment_group != 'Buffer')
  next_row <- tibble(assignment_group = c('Total estimated eligibles'),
                     Humans = sum(no_buffer$Humans),
                     `Total non-children` = sum(no_buffer$`Total non-children`),
                     Females = sum(no_buffer$Females),
                     `Non-child females` = sum(no_buffer$`Non-child females`),
                     `Estimated pregnant` = sum(no_buffer$`Estimated pregnant`)) %>%
        mutate(`Estimated pregnant` = Females * p_pregnant) %>%
    mutate(`Eligible for treatment` = `Total non-children` - `Estimated pregnant`) %>%
    mutate(`Coverage 90%` = `Eligible for treatment` * 0.9) %>%
    mutate(`Drug requirements 90` = `Coverage 90%` * 19.8) %>%
        mutate(`Coverage 80%` = `Eligible for treatment` * 0.8) %>%
    mutate(`Drug requirements 80` = `Coverage 80%` * 19.8) %>%
        mutate(`Coverage 70%` = `Eligible for treatment` * 0.7) %>%
    mutate(`Drug requirements 70` = `Coverage 70%` * 19.8) %>%
    mutate(assignment_group = as.character(assignment_group)) %>%
    mutate(assignment_group = ifelse(is.na(assignment_group), 'Buffer', assignment_group)) %>%
    dplyr::select(-`Non-child females`)
  final_row <- next_row
  for(j in 2:ncol(final_row)){
    final_row[,j] <- final_row[,j] * (2/3)
  }
  final_row$assignment_group <- 'Total estimated Ivermectin'
  
  final <- list()
  final[[1]] <- pdx %>%
    dplyr::rename(`Assignment group` = assignment_group)
  final[[2]] <- final_row %>%
      .$`Coverage 90%`
  children <- sum(pdx$Children[pdx$assignment_group %in% as.character(1:3)]) * (2/3)
  non_children <- sum(pdx$`Total non-children`[pdx$assignment_group %in% as.character(1:3)]) * (2/3)
  ratio <- non_children / children
  final[[3]] <- 
    paste0('Children in included clusters: ',
           round(children, digits = 2),
           '. Non-children: ',
          round(non_children, digits = 2),
          '. Ratio of non-children to children: ',
          round(ratio, digits = 2)
          )

  return(final)
}
```

## Tanzania

Note: this is excluding hamlets in other clinical trial.



Here, we present multiple results for Tanzania The reason: we want to see how clustering would be affected if we exclude certain hamlets based on difficulty of access, as reported by Imani in mid March.

First, a map of difficulty of access (click on hamlet to see points):

```{r}
x <- df %>% filter(country == 'Tanzania')
color_var <- rainbow(8)[c(5,4,2,1)][x$difficulty_value]

leaflet() %>%
  addProviderTiles(providers$Esri.WorldImagery) %>%
  addCircleMarkers(data = x,
                   color = color_var,
                   popup = paste0(x$code, '). ', x$difficulty, '. Households: ', x$n_households))
```

The distribution of difficulty of access by number of households / children is below:

```{r}
pd <- x %>%
  group_by(difficulty) %>%
  summarise(Households = sum(n_households),
            Children = sum(n_children)) %>%
  tidyr::gather(key, value, `Households`:`Children`)
pd$difficulty <- factor(pd$difficulty,
                        levels = c('Easy',
                                   'Normal',
                                   'Hard',
                                   'Very Hard'))

ggplot(data = pd,
       aes(x = difficulty,
           y = value,
           group = key,
           fill = key)) +
  geom_bar(stat = 'identity',
           position = position_dodge(width = 0.8)) +
  scale_fill_manual(name = '',
                    values = c('red', 'black')) +
  labs(x = 'Difficulty',
       y = '') +
  theme(legend.position = 'bottom') +
  geom_text(position = position_dodge(width = 0.8),
            aes(y = value + 1000,
                label = value))
  
```


The distribution of difficulty of access by number of hamlets is below:

```{r}
pd <- x %>%
  group_by(difficulty) %>%
  summarise(Hamlets = n()) %>%
  tidyr::gather(key, value, `Hamlets`)
pd$difficulty <- factor(pd$difficulty,
                        levels = c('Easy',
                                   'Normal',
                                   'Hard',
                                   'Very Hard'))

ggplot(data = pd,
       aes(x = difficulty,
           y = value,
           group = key,
           fill = key)) +
  geom_bar(stat = 'identity',
           position = position_dodge(width = 0.8)) +
  scale_fill_manual(name = '',
                    values = c('black')) +
  labs(x = 'Difficulty',
       y = '') +
  theme(legend.position = 'bottom') +
  geom_text(position = position_dodge(width = 0.8),
            aes(y = value + 10,
                label = value))
  
```

Next, we'll go through each difficulty level, excluding those that are more difficult than the level indicated.


### Including all hamlets


```{r, echo = TRUE}
set.seed(27)
keep_index <- which(!is.na(df$difficulty_value))
out <- try_clusters_hh_level(the_country = 'Tanzania',
                         include_clinical = FALSE,
                         minimum_households = 0,
                         minimum_children = 35,
                         minimum_humans = 0,
                         minimum_animals = 0,
                         minimum_cattle = 0,
                         minimum_pigs = 0,
                         minimum_goats = 0,
                         km = 2,
                         max_km_from_hq = 1000,
                         start_at_hq = FALSE,
                         df = df[keep_index,],
                         locations_list = locations_list[keep_index])
```


#### Summary

```{r, results='asis'}
cat(paste0(out$summary_text))
```

```{r, results='asis'}
f <- get_eligible_for_ttm(out = out)
cat(paste0('Estimated ', scales::comma(f[[2]]), ' people to be treated with ivermectin at 90% coverage'))
```


```{r, results = 'asis'}
cat(f[[3]])
```



```{r}
knitr::kable(f[[1]])
```

```{r}
out$map
```

```{r}
keep_only_n <- function(cluster_xdf, n = n_required){
  done <- cluster_xdf %>% filter(complete_cluster)
  done <- done %>% mutate(dummy = 1) %>% group_by(assignment_group) %>%
    mutate(cs = cumsum(dummy)) %>%
    ungroup %>%
    filter(cs <= n_required)
}
out_minimal <- keep_only_n(out$cluster_xdf)

# If we keep only the minimal number required (`r n_required` clusters per arm) and do not cense those in buffer areas, this is estimated to reduce the number of participating households from `r gps %>% filter(iso == 'TZA', clinical_trial == 0) %>% summarise(x = sum(n_households)) %>% .$x` to `r sum(out_minimal$n_households)`.
```



### Excluding the "very hard"



```{r, echo = TRUE}
set.seed(27)
keep_index <- which(!is.na(df$difficulty_value) & df$difficulty_value < 4)
out <- try_clusters_hh_level(the_country = 'Tanzania',
                         include_clinical = FALSE,
                         minimum_households = 0,
                         minimum_children = 35,
                         minimum_humans = 0,
                         minimum_animals = 0,
                         minimum_cattle = 0,
                         minimum_pigs = 0,
                         minimum_goats = 0,
                         km = 2,
                         max_km_from_hq = 1000,
                         start_at_hq = FALSE,
                         df = df[keep_index,],
                         locations_list = locations_list[keep_index])
```


#### Summary

```{r, results='asis'}
cat(paste0(out$summary_text))
```

```{r, results='asis'}
f <- get_eligible_for_ttm(out = out)
cat(paste0('Estimated ', scales::comma(f[[2]]), ' people to be treated with ivermectin at 90% coverage'))
```


```{r, results = 'asis'}
cat(f[[3]])
```



```{r}
knitr::kable(f[[1]])
```

```{r}
out$map
```


#### Humans and animals

The below shows the number of humans and animals per assignment group

```{r, fig.height = 10}
pd <- out$hamlet_xdf %>% #filter(cluster != 0) %>%
  left_join(df %>% dplyr::select(code,
                                 n_males, n_females,
                                 cows_1_year_plus, cows_babies, pigs_6_weeks_plus,
                                 pigs_babies))

pdx <- pd %>%
  group_by(assignment_group) %>%
  summarise(n_humans = sum(n_humans),
            n_females = sum(n_females),
            n_males = sum(n_males),
            n_households = sum(n_households),
            n_children = sum(n_children),
            n_cows_1_year_plus = sum(cows_1_year_plus), 
            n_cows_babies = sum(cows_babies),
            n_pigs_6_weeks_plus = sum(pigs_6_weeks_plus),
            n_pigs_babies = sum(pigs_babies)) %>%
  tidyr::gather(key, value, n_humans:n_pigs_babies) %>%
  mutate(key = gsub('n_', '', key)) %>%
  mutate(key = gsub('_', ' ', key)) %>%
  mutate(key = Hmisc::capitalize(key)) %>%
  mutate(assignment_group = ifelse(is.na(assignment_group),
                                   'None', as.character(assignment_group)))

ggplot(data = pdx,
       aes(x = assignment_group,
           y = value)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~key, scales = 'free') +
  labs(x = 'Assignment group',
       y = 'Value') +
  geom_text(aes(label = value),
            color = 'white',
            vjust = 1, 
            size = 3)

```


### Excluding the "very hard" and "hard" (ie, keeping only "normal" and "easy")


```{r, echo = TRUE}
set.seed(27)
keep_index <- which(!is.na(df$difficulty_value) & df$difficulty_value < 3)
out <- try_clusters_hh_level(the_country = 'Tanzania',
                         include_clinical = FALSE,
                         minimum_households = 0,
                         minimum_children = 35,
                         minimum_humans = 0,
                         minimum_animals = 0,
                         minimum_cattle = 0,
                         minimum_pigs = 0,
                         minimum_goats = 0,
                         km = 2,
                         max_km_from_hq = 1000,
                         start_at_hq = FALSE,
                         df = df[keep_index,],
                         locations_list = locations_list[keep_index])
```


#### Summary

```{r, results='asis'}
cat(paste0(out$summary_text))
```

```{r, results='asis'}
f <- get_eligible_for_ttm(out = out)
cat(paste0('Estimated ', scales::comma(f[[2]]), ' people to be treated with ivermectin at 90% coverage'))
```


```{r, results = 'asis'}
cat(f[[3]])
```



```{r}
knitr::kable(f[[1]])
```

```{r}
out$map
```


#### Humans and animals

The below shows the number of humans and animals per assignment group

```{r, fig.height = 10}
pd <- out$hamlet_xdf %>% #filter(cluster != 0) %>%
  left_join(df %>% dplyr::select(code,
                                 n_males, n_females,
                                 cows_1_year_plus, cows_babies, pigs_6_weeks_plus,
                                 pigs_babies))

pdx <- pd %>%
  group_by(assignment_group) %>%
  summarise(n_humans = sum(n_humans),
            n_females = sum(n_females),
            n_males = sum(n_males),
            n_households = sum(n_households),
            n_children = sum(n_children),
            n_cows_1_year_plus = sum(cows_1_year_plus), 
            n_cows_babies = sum(cows_babies),
            n_pigs_6_weeks_plus = sum(pigs_6_weeks_plus),
            n_pigs_babies = sum(pigs_babies)) %>%
  tidyr::gather(key, value, n_humans:n_pigs_babies) %>%
  mutate(key = gsub('n_', '', key)) %>%
  mutate(key = gsub('_', ' ', key)) %>%
  mutate(key = Hmisc::capitalize(key)) %>%
  mutate(assignment_group = ifelse(is.na(assignment_group),
                                   'None', as.character(assignment_group)))

ggplot(data = pdx,
       aes(x = assignment_group,
           y = value)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~key, scales = 'free') +
  labs(x = 'Assignment group',
       y = 'Value') +
  geom_text(aes(label = value),
            color = 'white',
            vjust = 1, 
            size = 3)

```


### Excluding the "very hard", "hard", and "normal" (ie, only keeping easy)

```{r, echo = TRUE}
set.seed(27)
keep_index <- which(!is.na(df$difficulty_value) & df$difficulty_value < 2)
out <- try_clusters_hh_level(the_country = 'Tanzania',
                         include_clinical = FALSE,
                         minimum_households = 0,
                         minimum_children = 35,
                         minimum_humans = 0,
                         minimum_animals = 0,
                         minimum_cattle = 0,
                         minimum_pigs = 0,
                         minimum_goats = 0,
                         km = 2,
                         max_km_from_hq = 1000,
                         start_at_hq = FALSE,
                         df = df[keep_index,],
                         locations_list = locations_list[keep_index])
```


#### Summary

```{r, results='asis'}
cat(paste0(out$summary_text))
```

```{r, results='asis'}
f <- get_eligible_for_ttm(out = out)
cat(paste0('Estimated ', scales::comma(f[[2]]), ' people to be treated with ivermectin at 90% coverage'))
```


```{r, results = 'asis'}
cat(f[[3]])
```



```{r}
knitr::kable(f[[1]])
```

```{r}
out$map
```


#### Humans and animals

The below shows the number of humans and animals per assignment group

```{r, fig.height = 10}
pd <- out$hamlet_xdf %>% #filter(cluster != 0) %>%
  left_join(df %>% dplyr::select(code,
                                 n_males, n_females,
                                 cows_1_year_plus, cows_babies, pigs_6_weeks_plus,
                                 pigs_babies))

pdx <- pd %>%
  group_by(assignment_group) %>%
  summarise(n_humans = sum(n_humans),
            n_females = sum(n_females),
            n_males = sum(n_males),
            n_households = sum(n_households),
            n_children = sum(n_children),
            n_cows_1_year_plus = sum(cows_1_year_plus), 
            n_cows_babies = sum(cows_babies),
            n_pigs_6_weeks_plus = sum(pigs_6_weeks_plus),
            n_pigs_babies = sum(pigs_babies)) %>%
  tidyr::gather(key, value, n_humans:n_pigs_babies) %>%
  mutate(key = gsub('n_', '', key)) %>%
  mutate(key = gsub('_', ' ', key)) %>%
  mutate(key = Hmisc::capitalize(key)) %>%
  mutate(assignment_group = ifelse(is.na(assignment_group),
                                   'None', as.character(assignment_group)))

ggplot(data = pdx,
       aes(x = assignment_group,
           y = value)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~key, scales = 'free') +
  labs(x = 'Assignment group',
       y = 'Value') +
  geom_text(aes(label = value),
            color = 'white',
            vjust = 1, 
            size = 3)

```




## Mozambique

Here, we present multiple results for Mozambique. The reason: we want to see how clustering would be affected if we exclude certain hamlets based on difficulty of access, as reported by Eldo in early March.

First, a map of difficulty of access (click on hamlet to see points):

```{r}
x <- df %>% filter(country == 'Mozambique')
color_var <- rainbow(8)[c(5,4,2,1)][x$difficulty_value]

leaflet() %>%
  addProviderTiles(providers$Esri.WorldImagery) %>%
  addCircleMarkers(data = x,
                   color = color_var,
                   popup = paste0(x$code, '). ', x$difficulty, '. Households: ', x$n_households))
```

The distribution of difficulty of access by number of households / children is below:

```{r}
pd <- x %>%
  group_by(difficulty) %>%
  summarise(Households = sum(n_households),
            Children = sum(n_children)) %>%
  tidyr::gather(key, value, `Households`:`Children`)
pd$difficulty <- factor(pd$difficulty,
                        levels = c('Easy',
                                   'Normal',
                                   'Hard',
                                   'Very Hard'))

ggplot(data = pd,
       aes(x = difficulty,
           y = value,
           group = key,
           fill = key)) +
  geom_bar(stat = 'identity',
           position = position_dodge(width = 0.8)) +
  scale_fill_manual(name = '',
                    values = c('red', 'black')) +
  labs(x = 'Difficulty',
       y = '') +
  theme(legend.position = 'bottom') +
  geom_text(position = position_dodge(width = 0.8),
            aes(y = value + 1000,
                label = value))
  
```


The distribution of difficulty of access by number of hamlets is below:

```{r}
pd <- x %>%
  group_by(difficulty) %>%
  summarise(Hamlets = n()) %>%
  tidyr::gather(key, value, `Hamlets`)
pd$difficulty <- factor(pd$difficulty,
                        levels = c('Easy',
                                   'Normal',
                                   'Hard',
                                   'Very Hard'))

ggplot(data = pd,
       aes(x = difficulty,
           y = value,
           group = key,
           fill = key)) +
  geom_bar(stat = 'identity',
           position = position_dodge(width = 0.8)) +
  scale_fill_manual(name = '',
                    values = c('black')) +
  labs(x = 'Difficulty',
       y = '') +
  theme(legend.position = 'bottom') +
  geom_text(position = position_dodge(width = 0.8),
            aes(y = value + 20,
                label = value))
  
```

Next, we'll go through each difficulty level, excluding those that are more difficult than the level indicated.


### Including all hamlets

(Except those 18 hamlets which Eldo has designated as being excluded from the location hierarchy entirely)

```{r, echo = TRUE}
set.seed(27)
keep_index <- which(!is.na(df$difficulty_value))
out <- try_clusters_hh_level(the_country = 'Mozambique',
                         include_clinical = FALSE,
                         minimum_households = 0,
                         minimum_children = 35,
                         minimum_humans = 0,
                         minimum_animals = 0,
                         minimum_cattle = 0,
                         minimum_pigs = 0,
                         minimum_goats = 0,
                         km = 2,
                         max_km_from_hq = 1000,
                         start_at_hq = FALSE,
                         df = df[keep_index,],
                         locations_list = locations_list[keep_index])
```

```{r}
out$map
```

#### Summary

```{r, results='asis'}
cat(paste0(out$summary_text))
```



```{r, results='asis'}
f <- get_eligible_for_ttm(out = out)
cat(paste0('Estimated ', scales::comma(f[[2]]), ' people to be treated with ivermectin at 90% coverage'))
```


```{r, results = 'asis'}
cat(f[[3]])
```


```{r}
knitr::kable(f[[1]])
```

#### Humans and animals

The below shows the number of humans and animals per assignment group

```{r, fig.height = 10}
pd <- out$hamlet_xdf %>% #filter(cluster != 0) %>%
  left_join(df %>% dplyr::select(code,
                                 n_males, n_females,
                                 cows_1_year_plus, cows_babies, pigs_6_weeks_plus,
                                 pigs_babies))

pdx <- pd %>%
  group_by(assignment_group) %>%
  summarise(n_humans = sum(n_humans),
            n_females = sum(n_females),
            n_males = sum(n_males),
            n_households = sum(n_households),
            n_children = sum(n_children),
            n_cows_1_year_plus = sum(cows_1_year_plus), 
            n_cows_babies = sum(cows_babies),
            n_pigs_6_weeks_plus = sum(pigs_6_weeks_plus),
            n_pigs_babies = sum(pigs_babies)) %>%
  tidyr::gather(key, value, n_humans:n_pigs_babies) %>%
  mutate(key = gsub('n_', '', key)) %>%
  mutate(key = gsub('_', ' ', key)) %>%
  mutate(key = Hmisc::capitalize(key)) %>%
  mutate(assignment_group = ifelse(is.na(assignment_group),
                                   'None', as.character(assignment_group)))

ggplot(data = pdx,
       aes(x = assignment_group,
           y = value)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~key, scales = 'free') +
  labs(x = 'Assignment group',
       y = 'Value') +
  geom_text(aes(label = value),
            color = 'white',
            vjust = 1, 
            size = 3)

```


### Excluding the "very hard"


```{r, echo = TRUE}
set.seed(13)
keep_index <- which(!is.na(df$difficulty_value) & df$difficulty_value < 4)
out <- try_clusters_hh_level(the_country = 'Mozambique',
                         include_clinical = FALSE,
                         minimum_households = 0,
                         minimum_children = 35,
                         minimum_humans = 0,
                         minimum_animals = 0,
                         minimum_cattle = 0,
                         minimum_pigs = 0,
                         minimum_goats = 0,
                         km = 2,
                         max_km_from_hq = 1000,
                         start_at_hq = FALSE,
                         df = df[keep_index,],
                         locations_list = locations_list[keep_index])
```

```{r}
out$map
```

#### Summary

```{r, results='asis'}
cat(paste0(out$summary_text))
```




```{r, results='asis'}
f <- get_eligible_for_ttm(out = out)
cat(paste0('Estimated ', scales::comma(f[[2]]), ' people to be treated with ivermectin at 90% coverage'))
```


```{r, results = 'asis'}
cat(f[[3]])
```


```{r}
knitr::kable(f[[1]])
```


#### Humans and animals

The below shows the number of humans and animals per assignment group

```{r, fig.height = 10}
pd <- out$hamlet_xdf %>% #filter(cluster != 0) %>%
  left_join(df %>% dplyr::select(code,
                                 n_males, n_females,
                                 cows_1_year_plus, cows_babies, pigs_6_weeks_plus,
                                 pigs_babies))

pdx <- pd %>%
  group_by(assignment_group) %>%
  summarise(n_humans = sum(n_humans),
            n_females = sum(n_females),
            n_males = sum(n_males),
            n_households = sum(n_households),
            n_children = sum(n_children),
            n_cows_1_year_plus = sum(cows_1_year_plus), 
            n_cows_babies = sum(cows_babies),
            n_pigs_6_weeks_plus = sum(pigs_6_weeks_plus),
            n_pigs_babies = sum(pigs_babies)) %>%
  tidyr::gather(key, value, n_humans:n_pigs_babies) %>%
  mutate(key = gsub('n_', '', key)) %>%
  mutate(key = gsub('_', ' ', key)) %>%
  mutate(key = Hmisc::capitalize(key)) %>%
  mutate(assignment_group = ifelse(is.na(assignment_group),
                                   'None', as.character(assignment_group)))

ggplot(data = pdx,
       aes(x = assignment_group,
           y = value)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~key, scales = 'free') +
  labs(x = 'Assignment group',
       y = 'Value') +
  geom_text(aes(label = value),
            color = 'white',
            vjust = 1, 
            size = 3)

```


### Excluding the "very hard" and "hard" (ie, keeping only "normal" and "easy")


```{r, echo = TRUE}
set.seed(5)
keep_index <- which(!is.na(df$difficulty_value) & df$difficulty_value < 3)
out <- try_clusters_hh_level(the_country = 'Mozambique',
                         include_clinical = FALSE,
                         minimum_households = 0,
                         minimum_children = 35,
                         minimum_humans = 0,
                         minimum_animals = 0,
                         minimum_cattle = 0,
                         minimum_pigs = 0,
                         minimum_goats = 0,
                         km = 2,
                         max_km_from_hq = 1000,
                         start_at_hq = FALSE,
                         df = df[keep_index,],
                         locations_list = locations_list[keep_index])
```

```{r}
out$map
```

#### Summary

```{r, results='asis'}
cat(paste0(out$summary_text))
```




```{r, results='asis'}
f <- get_eligible_for_ttm(out = out)
cat(paste0('Estimated ', scales::comma(f[[2]]), ' people to be treated with ivermectin at 90% coverage'))
```


```{r, results = 'asis'}
cat(f[[3]])
```


```{r}
knitr::kable(f[[1]])
```

#### Humans and animals

The below shows the number of humans and animals per assignment group

```{r, fig.height = 10}
pd <- out$hamlet_xdf %>% #filter(cluster != 0) %>%
  left_join(df %>% dplyr::select(code,
                                 n_males, n_females,
                                 cows_1_year_plus, cows_babies, pigs_6_weeks_plus,
                                 pigs_babies))

pdx <- pd %>%
  group_by(assignment_group) %>%
  summarise(n_humans = sum(n_humans),
            n_females = sum(n_females),
            n_males = sum(n_males),
            n_households = sum(n_households),
            n_children = sum(n_children),
            n_cows_1_year_plus = sum(cows_1_year_plus), 
            n_cows_babies = sum(cows_babies),
            n_pigs_6_weeks_plus = sum(pigs_6_weeks_plus),
            n_pigs_babies = sum(pigs_babies)) %>%
  tidyr::gather(key, value, n_humans:n_pigs_babies) %>%
  mutate(key = gsub('n_', '', key)) %>%
  mutate(key = gsub('_', ' ', key)) %>%
  mutate(key = Hmisc::capitalize(key)) %>%
  mutate(assignment_group = ifelse(is.na(assignment_group),
                                   'None', as.character(assignment_group)))

ggplot(data = pdx,
       aes(x = assignment_group,
           y = value)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~key, scales = 'free') +
  labs(x = 'Assignment group',
       y = 'Value') +
  geom_text(aes(label = value),
            color = 'white',
            vjust = 1, 
            size = 3)

```



### Excluding the "very hard", "hard", and "normal" (ie, only keeping easy)


```{r, echo = TRUE}
set.seed(5)
keep_index <- which(!is.na(df$difficulty_value) & df$difficulty_value < 2)
out <- try_clusters_hh_level(the_country = 'Mozambique',
                         include_clinical = FALSE,
                         minimum_households = 0,
                         minimum_children = 35,
                         minimum_humans = 0,
                         minimum_animals = 0,
                         minimum_cattle = 0,
                         minimum_pigs = 0,
                         minimum_goats = 0,
                         km = 2,
                         max_km_from_hq = 1000,
                         start_at_hq = FALSE,
                         df = df[keep_index,],
                         locations_list = locations_list[keep_index])
```

```{r}
out$map
```

#### Summary

```{r, results='asis'}
cat(paste0(out$summary_text))
```



```{r, results='asis'}
f <- get_eligible_for_ttm(out = out)
cat(paste0('Estimated ', scales::comma(f[[2]]), ' people to be treated with ivermectin at 90% coverage'))
```


```{r, results = 'asis'}
cat(f[[3]])
```


```{r}
knitr::kable(f[[1]])
```
#### Humans and animals

The below shows the number of humans and animals per assignment group

```{r, fig.height = 10}
pd <- out$hamlet_xdf %>% #filter(cluster != 0) %>%
  left_join(df %>% dplyr::select(code,
                                 n_males, n_females,
                                 cows_1_year_plus, cows_babies, pigs_6_weeks_plus,
                                 pigs_babies))

pdx <- pd %>%
  group_by(assignment_group) %>%
  summarise(n_humans = sum(n_humans),
            n_females = sum(n_females),
            n_males = sum(n_males),
            n_households = sum(n_households),
            n_children = sum(n_children),
            n_cows_1_year_plus = sum(cows_1_year_plus), 
            n_cows_babies = sum(cows_babies),
            n_pigs_6_weeks_plus = sum(pigs_6_weeks_plus),
            n_pigs_babies = sum(pigs_babies)) %>%
  tidyr::gather(key, value, n_humans:n_pigs_babies) %>%
  mutate(key = gsub('n_', '', key)) %>%
  mutate(key = gsub('_', ' ', key)) %>%
  mutate(key = Hmisc::capitalize(key)) %>%
  mutate(assignment_group = ifelse(is.na(assignment_group),
                                   'None', as.character(assignment_group)))

ggplot(data = pdx,
       aes(x = assignment_group,
           y = value)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~key, scales = 'free') +
  labs(x = 'Assignment group',
       y = 'Value') +
  geom_text(aes(label = value),
            color = 'white',
            vjust = 1, 
            size = 3)

```


```{r}
keep_only_n <- function(cluster_xdf, n = n_required){
  done <- cluster_xdf %>% filter(complete_cluster)
  done <- done %>% mutate(dummy = 1) %>% group_by(assignment_group) %>%
    mutate(cs = cumsum(dummy)) %>%
    ungroup %>%
    filter(cs <= n_required)
}
out_minimal <- keep_only_n(out$cluster_xdf)
out_maximal <- out$cluster_xdf


# If we do not cense those in buffer areas, this is estimated to reduce the number of participating households from `r sum(out_maximal$n_households)` to `r sum(out_minimal$n_households)`.

```

